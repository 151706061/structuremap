<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
	<head>
		<title>Injecting Services or Mocks at Runtime</title>
	</head>
	<body>
	<h1>Injecting Modules, Services, Mocks, and Stubs at Runtime</h1>
	<p>In the beginning (2003), there was attributes and Xml configuration, and I called it good.&nbsp; 
        Look Ma!&nbsp; I can radically change the behavior of the code without 
        recompiling, isn&#39;t that a marvelous thing?&nbsp; 
        Then we started to use StructureMap on a real project and quickly realized that 
        it would be very useful if we could override some services with mock objects in 
        our unit tests.&nbsp; In later projects I&#39;ve run into scenarios where it would 
        be valuable to put an object into StructureMap after it was created.&nbsp; Other 
        users have asked for the ability to load assemblies or modules of their system 
        on demand so as to save memory.&nbsp; A major goal of the StructureMap 2.5 
        release has been to greatly extend its capabilities for service registration at 
        runtime.&nbsp; With a very few exceptions, you can now make any and all 
        configuration changes after the first call to ObjectFactory.&nbsp; My 
        recommendation is to use this behavior simply and with caution because it will 
        bypass many of the diagnostic abilities built into StructureMap (i.e. 
        StructureMapDoctor might miss configuration problems introduced outside of the 
        normal configuration).</p>
        
        <h4>Injecting a Service at Runtime</h4>
        <p>In my desktop applications the main form usually implements some sort of 
            IApplicationShell interface.&nbsp; I&#39;ve found it valuable to place the main form 
            itself into StructureMap, as well as several child controls of the main form as 
            well so that various Controllers, Presenters, and Commands can interact with 
            parts of the main shell without tight coupling.&nbsp; I probably could build the ApplicationShell 
            itself inside of StructureMap, but the child controls like (I&#39;m making this up) 
            IQueryToolBar or IExplorerPane are easiest to create as part of the 
            ApplicationShell and loaded into StructureMap later.</p>
<!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red0\green0\blue255;\red43\green145\blue175;}??\fs20     \cf3 public\cf0  \cf3 class\cf0  \cf4 ApplicationShell\cf0  : \cf4 Form\cf0 , \cf4 IApplicationShell\par ??\cf0     \{\par ??        \par ??    \}}
-->
    <div style="font-family: Courier New; font-size: 10pt; color: black; background: white;">
        <p style="margin: 0px;">
            &nbsp;</p>
<!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red0\green0\blue255;\red43\green145\blue175;}??\fs20     \cf3 public\cf0  \cf3 class\cf0  \cf4 ApplicationShell\cf0  : \cf4 Form\cf0 , \cf4 IApplicationShell\par ??\cf0     \{\par ??        \cf3 public\cf0  \cf4 IQueryToolBar\cf0  QueryToolBar\par ??        \{\par ??            \cf3 get\par ??\cf0             \{\par ??                \cf3 return\cf0  \cf3 null\cf0 ;\par ??            \}\par ??        \}\par ??\par ??        \cf3 public\cf0  \cf4 IExplorerPane\cf0  ExplorerPane\par ??        \{\par ??            \cf3 get\par ??\cf0             \{\par ??                \cf3 return\cf0  \cf3 null\cf0 ;\par ??            \}\par ??        \}\par ??    \}}
-->
        <div style="font-family: Courier New; font-size: 10pt; color: black; background: white;">
            <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">class</span>
                <span style="color: #2b91af;">ApplicationShell</span> :
                <span style="color: #2b91af;">Form</span>, <span style="color: #2b91af;">
                IApplicationShell</span></p>
            <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp; {</p>
            <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span>
                <span style="color: #2b91af;">IQueryToolBar</span> QueryToolBar...</p>
            <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span>
                <span style="color: #2b91af;">IExplorerPane</span> ExplorerPane...</p>
            <p style="margin: 0px;">
                &nbsp;</p>
            <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp; }</p>
        </div>
<!--EndFragment-->
</div>
<!--EndFragment-->
<p>Easy enough.&nbsp; The main shell has some controls on it.&nbsp; Now, we may want 
    a centralized class to govern the behavior of just the query tool bar along the 
    top of the main form.&nbsp; That class obviously needs to find the IQueryToolBar 
    on the main form, but I need a clean way of connecting the IQueryToolBar to this 
    new QueryController class.</p>
<!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red0\green0\blue255;\red43\green145\blue175;}??\fs20     \cf3 public\cf0  \cf3 class\cf0  \cf4 QueryController\par ??\cf0     \{\par ??        \cf3 private\cf0  \cf4 IQueryToolBar\cf0  _toolBar;\par ??\par ??        \cf3 public\cf0  QueryController(\cf4 IQueryToolBar\cf0  toolBar)\par ??        \{\par ??            _toolBar = toolBar;\par ??        \}\par ??    \}}
-->
<div style="font-family: Courier New; font-size: 10pt; color: black; background: white;">
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">
        class</span> <span style="color: #2b91af;">QueryController</span></p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp; {</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">private</span>
        <span style="color: #2b91af;">IQueryToolBar</span> _toolBar;</p>
    <p style="margin: 0px;">
        &nbsp;</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> 
        QueryController(<span style="color: #2b91af;">IQueryToolBar</span> toolBar)</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _toolBar = toolBar;</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp; }</p>
</div>
<!--EndFragment-->
<p>StructureMap is going to build up the QueryController, but it doesn&#39;t help to 
    inject in a new IQueryToolBar that isn&#39;t visible anywhere in the application.&nbsp; 
    We need to get to exactly the right instance of that control.&nbsp; So let&#39;s use 
    the new Inject&lt;T&gt;(T instance) method on ObjectFactory to register the child 
    controls from the main form.</p>
<!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red0\green128\blue0;\red43\green145\blue175;\red0\green0\blue255;}??\fs20             \cf3 // Familiar stuff for the average WinForms or WPF developer\par ??\cf0             \cf3 // Create the main form\par ??\cf0             \cf4 ApplicationShell\cf0  shell = \cf5 new\cf0  \cf4 ApplicationShell\cf0 ();\par ??\par ??            \cf3 // Put the main form, and some of its children into StructureMap\par ??\cf0             \cf3 // where other Controllers and Commands can get to them\par ??\cf0             \cf3 // without being coupled to the main form\par ??\cf0             \cf4 ObjectFactory\cf0 .Inject&lt;\cf4 IApplicationShell\cf0 &gt;(shell);\par ??            \cf4 ObjectFactory\cf0 .Inject&lt;\cf4 IQueryToolBar\cf0 &gt;(shell.QueryToolBar);\par ??            \cf4 ObjectFactory\cf0 .Inject&lt;\cf4 IExplorerPane\cf0 &gt;(shell.ExplorerPane);\par ??\par ??\par ??            \cf4 Application\cf0 .Run(shell);}
-->
<div style="font-family: Courier New; font-size: 10pt; color: black; background: white;">
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: green;">// Familiar stuff for the average WinForms or WPF 
        developer</span></p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: green;">// Create the main form</span></p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: #2b91af;">ApplicationShell</span> shell =
        <span style="color: blue;">new</span> <span style="color: #2b91af;">
        ApplicationShell</span>();</p>
    <p style="margin: 0px;">
        &nbsp;</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: green;">// Put the main form, and some of its children into 
        StructureMap</span></p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: green;">// where other Controllers and Commands can get to 
        them</span></p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: green;">// without being coupled to the main form</span></p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: #2b91af;">ObjectFactory</span>.Inject&lt;<span 
            style="color: #2b91af;">IApplicationShell</span>&gt;(shell);</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: #2b91af;">ObjectFactory</span>.Inject&lt;<span 
            style="color: #2b91af;">IQueryToolBar</span>&gt;(shell.QueryToolBar);</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: #2b91af;">ObjectFactory</span>.Inject&lt;<span 
            style="color: #2b91af;">IExplorerPane</span>&gt;(shell.ExplorerPane);</p>
    <p style="margin: 0px;">
        &nbsp;</p>
    <p style="margin: 0px;">
        &nbsp;</p>
    <p style="margin: 0px;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="color: #2b91af;">Application</span>.Run(shell);</p>
</div>
<!--EndFragment-->
<p>I&#39;ve used this exact strategy on three applications now to great s.Run(shell);</p>
</div>
<!--EndFragment-->
<p>Now, a call to ObjectFactory.GetInstance&lt;QueryController&gt;() will poke the 
    IQueryToolBar instance we registered above into the constructor of the new 
    QueryController object.&nbsp; Remember, one of the primary usages of 
    StructureMap is simply to get the right service dependencies and metadata to the 
    right concrete classes so you can concentrate on doing QueryController stuff in 
    the QueryController class instead of bootstrapping all the stuff it needs.</p>
<p>I&#39;ve used this exact strategy on three applications now to great success.&nbsp; 
    The previous design had a lot of &quot;thisThing.ThatThing.QueryToolBar&quot; properties 
    just to get access to the child controls on the main form.&nbsp; It was 
    devolving into spaghetti code before I adopted the strategy above.</p>
<p>The ObjectFactory.Inject&lt;T&gt;(T instance) method is identical to the older 
    ObjectFactory.InjectStub&lt;T&gt;(T stub) method.&nbsp; I&#39;ve marked the older method 
    as deprecated because I think the name is misleading.&nbsp; </p>
<p>Use this strategy for any type of service or component that you need to inject 
    into other services, but isn&#39;t convenient or possible to build through 
    StructureMap itself.</p>
        <h4>Injecting a Mock or a Stub at Runtime</h4>
    <p>On its maiden cruise in 2004, my team quickly realized that we needed a way to
On its maiden cruise in 2004, my team quickly realized that we needed a way to 
        make StructureMap deliver up mock objects in unit tests.&nbsp; It obviously 
        isn&#39;t efficient to muck with an Xml file for each and every unit test that 
        requires this function, so we wanted a way to temporarily load ObjectFactory up 
        with a mock object in place of its normal behavior for a given type.</p>
        <h4></h4>
        <h4></h4>
        <h4></h4>
        <h4></h4>
	</body>
</html>